<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="css/framework7.ios.min.css">
    <link rel="stylesheet" href="css/framework7.ios.colors.min.css">
    <link rel="stylesheet" href="css/framework7.material.min.css">
    <link rel="stylesheet" href="css/framework7.material.colors.min.css">
    <link rel="stylesheet" href="css/upscroller.css">
    <link rel="stylesheet" href="css/my-app.css">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <script src="js/jquery-3.1.0.min.js"></script>
    <script src="http://app.miwifi.com/js/router_request.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <title>frp客户端配置</title>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link href="css/reset.css" rel="stylesheet" type="text/css">
    <link href="css/mui-switch.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="views">

    <div class="view view-main">
        <div class="navbar">
            <div class="navbar-inner">
                <table width="100%">
                    <tr id="frpc_status">
                        <td ><font colour="#FFFFFF">插件状态</font>&nbsp;<font size="2px" color="#d3d3d3">frpc版本:{{version}}&nbsp;&nbsp;
                            <font color="red">进程:{{status}}</font></font></td>
                        <td align="right"><input width="150" v-model="run_status" v-on:click="runFrpc(run_status)" class="mui-switch mui-switch-anim" type="checkbox"></td>
                    </tr>
                </table>

            </div>
        </div>


        <a href="javascript:" style="display: none;"
           class="floating-button addbtn color-pink"><i
                class="icon icon-plus"></i></a>

        <!--绑定-->
        <div id="intisync"
             style="width:100%; height: 100%; overflow :auto; background-color: #ffffff;"
             class="pages navbar-through toolbar-through">
            <div class="page-content">
                <div class="list-block">
                    <center id="select_config">

                        <input type="radio" name="config" id="red" value="base"><strong>基本配置</strong>
                        <input type="radio" name="config" id="blue" value="user"><strong>自定义配置</strong>

                    </center>
                    <hr/>
                    <form id="common">
                        <table align="center" style="width: 90%">
                            <tr style="width: 30%">
                                <td class="text_right">服务器：</td>
                                <td><input v-model="server_addr" type="text" placeholder="127.0.0.1"></td>
                            </tr>
                            <tr>
                                <td class="text_right">端口：</td>
                                <td><input v-model="server_port" type="text" placeholder="7000" name="port"></td>
                            </tr>
                            <tr>
                                <td class="text_right">token：</td>
                                <td><input v-model="token" type="text" placeholder="token"></td>
                            </tr>
                            <tr>
                                <td class="text_right">日志记录：</td>
                                <td><input v-model="log_on" width="150"
                                           class="mui-switch mui-switch-anim" type="checkbox"></td>
                            </tr>
                            <!-- trace, debug, info, warn, error -->
                            <tr class="text_right">
                                <td>日志级别：</td>
                                <td>
                                    <select v-model="log_level" name="log_level">
                                        <option value="trace">trace</option>
                                        <option value="debug">debug</option>
                                        <option value="info">info</option>
                                        <option value="warn">warn</option>
                                        <option value="error">error</option>
                                    </select></td>
                            </tr>
                            <tr>
                                <td class="text_right">日志天数：</td>
                                <td><input v-model="log_days" type="number" name="log_days" placeholder="3"></td>
                            </tr>


                            <tr class="text_right">
                                <td>tcp_mux：</td>
                                <td class="text_left">
                                    <input v-model="tcp_mux" class="mui-switch mui-switch-anim" type="checkbox"/>
                                </td>
                            </tr>

                            <tr class="text_right">
                                <td>协议：</td>
                                <td>
                                    <select v-model="protocol">
                                        <option value="tcp">tcp</option>
                                        <option value="kcp">kcp</option>
                                    </select></td>
                            </tr>
                            <tr class="text_right">
                                <td>login_fail_exit：</td>
                                <td class="text_left">
                                    <input v-model="login_fail_exit" class="mui-switch mui-switch-anim"
                                           type="checkbox"/>
                            </tr>

                        </table>
                        <hr/>

                    </form>
                    <center>列表</center>
                    <ul id="v-for-object">

                        <li v-for="(value,index) in object" class="swipeout">
                            <div class="item-content">
                                <div class="item-inner">
                                    <table>
                                        <tr>
                                            <td width="70">名称:</td>
                                            <td><input v-model="value.name" type="text" placeholder="名称"/></td>
                                            <td width="70">协议:</td>
                                            <td><select v-model="value.type">
                                                <option value="tcp">tcp</option>
                                                <option value="udp">udp</option>
                                                <option value="stcp">stcp</option>
                                                <option value="http">http</option>
                                                <option value="https">https</option>
                                            </select></td>
                                        </tr>
                                        <tr>
                                            <td>IP:</td>
                                            <td><input v-model="value.local_ip" type="text" placeholder="内网地址">
                                            </td>
                                            <td>端口1</td>
                                            <td><input v-model="value.local_port" type="text" placeholder="内网端口">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>端口2</td>
                                            <td><input v-model="value.remote_port" type="text" placeholder="远程端口">
                                            </td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td>子域名</td>
                                            <td><input v-model="value.subdomain" type="text"
                                                       placeholder="subdomain"></td>
                                            <td>域名</td>
                                            <td><input v-model="value.custom_domains" type="text"
                                                       placeholder="custom_domains"/></td>
                                        </tr>
                                        <tr>
                                            <td width="60">压缩</td>
                                            <td><input width="150" v-model="value.use_encryption"
                                                       class="mui-switch mui-switch-anim" type="checkbox"></td>
                                            <td width="60">加密</td>
                                            <td><input width="150" v-model="value.use_compression"
                                                       class="mui-switch mui-switch-anim" type="checkbox"></td>
                                        </tr>
                                    </table>


                                    <div class="swipeout-actions-right"><a :del_id="index" href=""
                                                                           onclick="deletelist(this)"
                                                                           class="swipeout-delete">删除</a>
                                    </div>
                                </div>
                            </div>
                        </li>

                    </ul>
                    <button id="savebase" class="button button-fill color-red"
                            style="width: 100%">保存
                    </button>
                    <hr/>


                </div>
            </div>
        </div>
        <!--绑定-->


    </div>
</div>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/framework7.min.js"></script>
<!-- Path to your app js-->
<script type="text/javascript" src="js/upscroller.js"></script>
<script type="text/javascript" src="js/my-app.js"></script>
<template id="template">
    <div class="checkbox-wrapper" @click="check">
        <div :class="{ checkbox: true, checked: checked }"></div>
        <div class="title"></div>
    </div>
</template>
<script>
    var commonConfig = {};
    var configList = [];
    var common;
    var lists;
    var frpc_status;

    $(".addbtn").click(function () {
        configList.push({
            type: "http",
            local_ip: "",
            local_port: "",
            remote_port: "",
            use_encryption: false,
            use_compression: false,
            use_compression: false,
            subdomain: "",
            custom_domains: ""
        })

    });

    var status = 0;
    var appId = "2882303761517844809";

    $(document).ready(function () {
        $("#authorizeButton").click(function () {
            if (!routerRequest.hasAccessToken()) {
                routerRequest.authorize(window.location.href, appId);
            }
        });

        $("#savebase").click(function () {

            configData = {common: common.$data};
            $.each(lists.$data.object, function (index, item) {
                key_name = item.name;
                configData[key_name] = {}
                $.each(item, function (key, val) {
                    if (key != "name") {
                        configData[key_name][key] = val;
                    }
                });
            });

            datesend = {
                method: "saveConfig",
                data: configData
            };
            //alert(JSON.stringify(datesend));
            configData = encodeURIComponent(JSON.stringify(configData));

            //详细列表设置
            routerRequest.request({
                path: "/api-third-party/service/datacenter/set_config",
                type: "GET",
                data: {
                    appId: appId,
                    key: "frpc_config",
                    value: configData
                },
                success: function (data) {
                    var response = jQuery.parseJSON(data);
                    if (response.code != 0) {
                        console.log(data);
                        alert("错误：" + response.msg);
                        return;
                    }
                },
                error: function (data) {
                    console.log("set_config:", data);
                    alert("网络失败");
                }
            });


            routerRequest.request({
                path: "/api-third-party/service/datacenter/plugin_control",
                type: "GET",
                data: {
                    appId: appId,
                    info: JSON.stringify(datesend)
                },
                success: function (data) {
                    var response = jQuery.parseJSON(data);
                    if (response.code != 0) {
                        console.log(data);
                        alert("错误：" + response.msg);
                        return;
                    }
                    alert("配置保存成功，请重启frpc进程")

                },
                error: function (data) {
                    alert("saveconfig:" + data);
                }
            });

            return;
        });

        loadconfig();
        show_hide(status);

    });


    function loadconfig() {
        //启用插件
        routerRequest.request({
            path: "/api-third-party/service/datacenter/plugin_enable",
            type: "GET",
            data: {
                appId: appId
            },
            success: function (res) {
            },
            error: function (data) {
            }
        });

        //代理设置
        routerRequest.request({
            path: "/api-third-party/service/datacenter/config_info",
            type: "GET",
            data: {
                appId: appId,
                key: "frpc_config"
            },
            success: function (data) {
                var response = jQuery.parseJSON(data);
                if (response.code != 0) {
                    console.log(data);
                    alert("错误：" + response.msg);
                    return;
                }
                //alert(data);

                frpc_config = decodeURIComponent(response.value);
                //alert(frpc_config);
                if (frpc_config == "") {
                    commonConfig = {
                        server_addr: "",
                        server_port: "",
                        token: "",
                        log_on: true,
                        log_file: "./frpc.log",
                        log_days: "",
                        log_level: "error",
                        tcp_mux: true,
                        protocol: "tcp",
                        tcp_mux: false,
                        login_fail_exit: false
                    };

                    configList = [{
                        name: "router",
                        type: "tcp",
                        local_ip: "frp.mtjo.net",
                        local_port: "80",
                        use_encryption: true,
                        use_compression: false,
                        use_compression: false,
                        subdomain: "mtjo",
                        custom_domains: "router.mtjo.net"
                    },
                        {
                            name: "ssh",
                            type: "https",
                            local_ip: "127.0.0.1",
                            local_port: "2222",
                            use_encryption: true,
                            use_compression: false,
                            use_compression: false,
                            subdomain: "",
                            custom_domains: ""
                        }];

                } else {
                    jsonobj = jQuery.parseJSON(frpc_config);

                    //alert(jsonobj)
                    i = 0
                    $.each(jsonobj, function (index, item) {
                        if (index == "common") {
                            commonConfig = item;
                        } else {
                            item['name'] = index;
                            configList[i++] = item;
                        }

                    });
                    //alert(JSON.stringify(commonConfig));
                    //alert(JSON.stringify(configList));
                }
                common = new Vue({
                    el: '#common',
                    data: commonConfig
                })

                lists = new Vue({
                    el: '#v-for-object',
                    data: {
                        object: configList
                    }

                })

            },
            error: function (data) {
                console.log("error:", data);
                alert("网络失败");
            }
        });


        //插件状态
        routerRequest.request({
            path: "/api-third-party/service/datacenter/plugin_control",
            type: "GET",
            data: {
                appId: appId,
                info: JSON.stringify({method: "getStatus"})
            },
            success: function (data) {

                var response = jQuery.parseJSON(data);
                if (response.code != 0) {
                    console.log(data);
                    alert("错误：" + response.msg);
                    return;
                }
                //alert(data);

                var ps = response.data.ps;

                var reg = /(\d+)((?=.*frpc -c)(?!.*sh))/g;

                var res = ps.match(reg);
                //alert(res);

                var pid = 0;
                if (res!=null&& res.length>0){
                    pid = res[0];
                }
                if (pid>0){
                    response.data.status = pid;
                    response.data.run_status = true;
                }else{
                    response.data.status = "未运行";
                    response.data.run_status = false;


                }
                frpc_status = new Vue({
                    el: '#frpc_status',
                    data: response.data,
                    methods:{
                            runFrpc:function(item){
                                method = "";
                                if (item){
                                    method ="runFrpc";
                                } else{
                                    method ="stopFrpc";
                                }
                                alert(method);
                                routerRequest.request({
                                    path: "/api-third-party/service/datacenter/plugin_control",
                                    type: "GET",
                                    data: {
                                        appId: appId,
                                        info: JSON.stringify({method: method})
                                    },
                                    success: function (data) {
                                        var response = jQuery.parseJSON(data);
                                        // if (response.code != 0) {
                                        //     console.log(data);
                                        //     alert("错误：" + response.msg);
                                        //     return;
                                        // }
                                        alert(data);

                                    },
                                    error: function (data) {
                                        alert("plugin_control:" + data);
                                    }
                                });
                            }
                        }
                })

            },
            error: function (data) {
                alert("plugin_control:" + data);
            }
        });


    }

    function deletelist(obj) {
        del_id = $(obj).attr("del_id");
        configList.splice(del_id, 1);
    }

    function show_hide(show) {
        $("#status").attr("checked", "checked");
        $("#syncset").show();
        $("#configlist").show();
        $(".addbtn").show();
        $("#intisync").show();
    }

</script>
</body>
</html>

